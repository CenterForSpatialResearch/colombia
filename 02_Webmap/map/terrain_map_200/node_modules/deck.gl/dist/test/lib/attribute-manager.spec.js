'use strict';

var _attributeManager = require('./attribute-manager');

var _tapeCatch = require('tape-catch');

var _tapeCatch2 = _interopRequireDefault(_tapeCatch);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

/* eslint-disable dot-notation, max-statements, no-unused-vars */
function update(attribute, _ref) {
  var data = _ref.data;
  var value = attribute.value,
      size = attribute.size;

  var i = 0;
  var _iteratorNormalCompletion = true;
  var _didIteratorError = false;
  var _iteratorError = undefined;

  try {
    for (var _iterator = data[Symbol.iterator](), _step; !(_iteratorNormalCompletion = (_step = _iterator.next()).done); _iteratorNormalCompletion = true) {
      var object = _step.value;

      for (var n = 0; n < size; ++n) {
        value[i + n] = i + n;
      }
      i += size;
    }
  } catch (err) {
    _didIteratorError = true;
    _iteratorError = err;
  } finally {
    try {
      if (!_iteratorNormalCompletion && _iterator.return) {
        _iterator.return();
      }
    } finally {
      if (_didIteratorError) {
        throw _iteratorError;
      }
    }
  }
}

var fixture = {
  positions: new Float32Array([0, 1, 0, -1, -1, 0, 1, -1, 0])
};

(0, _tapeCatch2.default)('Core#AttributeManager constructor', function (t) {
  var attributeManager = new _attributeManager.AttributeManager();

  t.ok(attributeManager, 'AttributeManager construction successful');
  t.end();
});

(0, _tapeCatch2.default)('Core#AttributeManager.add', function (t) {
  var attributeManager = new _attributeManager.AttributeManager();

  t.throws(function () {
    return attributeManager.add({ positions: { update: update } });
  }, 'AttributeManager.add - throws on missing attribute size');

  t.throws(function () {
    return attributeManager.add({ positions: { size: 2 } });
  }, 'AttributeManager.add - throws on missing attribute update');

  attributeManager.add({ positions: { size: 2, update: update } });
  t.ok(attributeManager.getAttributes()['positions'], 'AttributeManager.add - add attribute successful');
  t.end();
});

(0, _tapeCatch2.default)('Core#AttributeManager.update', function (t) {
  var attributeManager = new _attributeManager.AttributeManager();
  attributeManager.add({ positions: { size: 2, update: update } });

  var attribute = void 0;

  // First update, should autoalloc and update the value array
  attributeManager.update({
    numInstances: 1,
    data: [{}]
  });

  attribute = attributeManager.getAttributes()['positions'];
  t.ok(ArrayBuffer.isView(attribute.value), 'attribute has typed array');
  t.equals(attribute.value[1], 1, 'attribute value is correct');

  // Second update without invalidation, should not update
  attribute.value[1] = 2;

  attributeManager.update({
    numInstances: 1,
    data: [{}]
  });

  attribute = attributeManager.getAttributes()['positions'];
  t.ok(ArrayBuffer.isView(attribute.value), 'attribute has typed array');
  t.equals(attribute.value[1], 2, 'Second update, attribute value was not changed');

  // Third update, with invalidation, should update
  attributeManager.invalidateAll();
  attributeManager.update({
    numInstances: 1,
    data: [{}]
  });

  attribute = attributeManager.getAttributes()['positions'];
  t.ok(ArrayBuffer.isView(attribute.value), 'attribute has typed array');
  t.equals(attribute.value[1], 1, 'Third update, attribute value was updated');

  t.end();
});

(0, _tapeCatch2.default)('Core#AttributeManager.update - 0 numInstances', function (t) {
  var attributeManager = new _attributeManager.AttributeManager();
  attributeManager.add({ positions: { size: 2, update: update } });

  // First update, should autoalloc and update the value array
  attributeManager.update({
    numInstances: 0,
    data: []
  });

  var attribute = attributeManager.getAttributes()['positions'];
  t.ok(ArrayBuffer.isView(attribute.value), 'attribute has typed array');

  t.end();
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy90ZXN0L2xpYi9hdHRyaWJ1dGUtbWFuYWdlci5zcGVjLmpzIl0sIm5hbWVzIjpbInVwZGF0ZSIsImF0dHJpYnV0ZSIsImRhdGEiLCJ2YWx1ZSIsInNpemUiLCJpIiwib2JqZWN0IiwibiIsImZpeHR1cmUiLCJwb3NpdGlvbnMiLCJGbG9hdDMyQXJyYXkiLCJhdHRyaWJ1dGVNYW5hZ2VyIiwidCIsIm9rIiwiZW5kIiwidGhyb3dzIiwiYWRkIiwiZ2V0QXR0cmlidXRlcyIsIm51bUluc3RhbmNlcyIsIkFycmF5QnVmZmVyIiwiaXNWaWV3IiwiZXF1YWxzIiwiaW52YWxpZGF0ZUFsbCJdLCJtYXBwaW5ncyI6Ijs7QUFDQTs7QUFDQTs7Ozs7O0FBRkE7QUFJQSxTQUFTQSxNQUFULENBQWdCQyxTQUFoQixRQUFtQztBQUFBLE1BQVBDLElBQU8sUUFBUEEsSUFBTztBQUFBLE1BQzFCQyxLQUQwQixHQUNYRixTQURXLENBQzFCRSxLQUQwQjtBQUFBLE1BQ25CQyxJQURtQixHQUNYSCxTQURXLENBQ25CRyxJQURtQjs7QUFFakMsTUFBSUMsSUFBSSxDQUFSO0FBRmlDO0FBQUE7QUFBQTs7QUFBQTtBQUdqQyx5QkFBcUJILElBQXJCLDhIQUEyQjtBQUFBLFVBQWhCSSxNQUFnQjs7QUFDekIsV0FBSyxJQUFJQyxJQUFJLENBQWIsRUFBZ0JBLElBQUlILElBQXBCLEVBQTBCLEVBQUVHLENBQTVCLEVBQStCO0FBQzdCSixjQUFNRSxJQUFJRSxDQUFWLElBQWVGLElBQUlFLENBQW5CO0FBQ0Q7QUFDREYsV0FBS0QsSUFBTDtBQUNEO0FBUmdDO0FBQUE7QUFBQTtBQUFBO0FBQUE7QUFBQTtBQUFBO0FBQUE7QUFBQTtBQUFBO0FBQUE7QUFBQTtBQUFBO0FBQUE7QUFTbEM7O0FBRUQsSUFBTUksVUFBVTtBQUNkQyxhQUFXLElBQUlDLFlBQUosQ0FBaUIsQ0FBQyxDQUFELEVBQUksQ0FBSixFQUFPLENBQVAsRUFBVSxDQUFDLENBQVgsRUFBYyxDQUFDLENB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QixDQUFxQixFQUFDUCxXQUFXLEVBQUNMLE1BQU0sQ0FBUCxFQUFVSixjQUFWLEVBQVosRUFBckI7O0FBRUE7QUFDQVcsbUJBQWlCWCxNQUFqQixDQUF3QjtBQUN0QmtCLGtCQUFjLENBRFE7QUFFdEJoQixVQUFNO0FBRmdCLEdBQXhCOztBQUtBLE1BQU1ELFlBQVlVLGlCQUFpQk0sYUFBakIsR0FBaUMsV0FBakMsQ0FBbEI7QUFDQUwsSUFBRUMsRUFBRixDQUFLTSxZQUFZQyxNQUFaLENBQW1CbkIsVUFBVUUsS0FBN0IsQ0FBTCxFQUEwQywyQkFBMUM7O0FBRUFTLElBQUVFLEdBQUY7QUFDRCxDQWREIiwiZmlsZSI6ImF0dHJpYnV0ZS1tYW5hZ2VyLnNwZWMuanMiLCJzb3VyY2VzQ29udGVudCI6WyIvKiBlc2xpbnQtZGlzYWJsZSBkb3Qtbm90YXRpb24sIG1heC1zdGF0ZW1lbnRzLCBuby11bnVzZWQtdmFycyAqL1xuaW1wb3J0IHtBdHRyaWJ1dGVNYW5hZ2VyfSBmcm9tICcuL2F0dHJpYnV0ZS1tYW5hZ2VyJztcbmltcG9ydCB0ZXN0IGZyb20gJ3RhcGUtY2F0Y2gnO1xuXG5mdW5jdGlvbiB1cGRhdGUoYXR0cmlidXRlLCB7ZGF0YX0pIHtcbiAgY29uc3Qge3ZhbHVlLCBzaXplfSA9IGF0dHJpYnV0ZTtcbiAgbGV0IGkgPSAwO1xuICBmb3IgKGNvbnN0IG9iamVjdCBvZiBkYXRhKSB7XG4gICAgZm9yIChsZXQgbiA9IDA7IG4gPCBzaXplOyArK24pIHtcbiAgICAgIHZhbHVlW2kgKyBuXSA9IGkgKyBuO1xuICAgIH1cbiAgICBpICs9IHNpemU7XG4gIH1cbn1cblxuY29uc3QgZml4dHVyZSA9IHtcbiAgcG9zaXRpb25zOiBuZXcgRmxvYXQzMkFycmF5KFswLCAxLCAwLCAtMSwgLTEsIDAsIDEsIC0xLCAwXSlcbn07XG5cbnRlc3QoJ0NvcmUjQXR0cmlidXRlTWFuYWdlciBjb25zdHJ1Y3RvcicsIHQgPT4ge1xuICBjb25zdCBhdHRyaWJ1dGVNYW5hZ2VyID0gbmV3IEF0dHJpYnV0ZU1hbmFnZXIoKTtcblxuICB0Lm9rKGF0dHJpYnV0ZU1hbmFnZXIsICdBdHRyaWJ1dGVNYW5hZ2VyIGNvbnN0cnVjdGlvbiBzdWNjZXNzZnVsJyk7XG4gIHQuZW5kKCk7XG59KTtcblxudGVzdCgnQ29yZSNBdHRyaWJ1dGVNYW5hZ2VyLmFkZCcsIHQgPT4ge1xuICBjb25zdCBhdHRyaWJ1dGVNYW5hZ2VyID0gbmV3IEF0dHJpYnV0ZU1hbmFnZXIoKTtcblxuICB0LnRocm93cyhcbiAgICAoKSA9PiBhdHRyaWJ1dGVNYW5hZ2VyLmFkZCh7cG9zaXRpb25zOiB7dXBkYXRlfX0pLFxuICAgICdBdHRyaWJ1dGVNYW5hZ2VyLmFkZCAtIHRocm93cyBvbiBtaXNzaW5nIGF0dHJpYnV0ZSBzaXplJ1xuICApO1xuXG4gIHQudGhyb3dzKFxuICAgICgpID0+IGF0dHJpYnV0ZU1hbmFnZXIuYWRkKHtwb3NpdGlvbnM6IHtzaXplOiAyfX0pLFxuICAgICdBdHRyaWJ1dGVNYW5hZ2VyLmFkZCAtIHRocm93cyBvbiBtaXNzaW5nIGF0dHJpYnV0ZSB1cGRhdGUnXG4gICk7XG5cbiAgYXR0cmlidXRlTWFuYWdlci5hZGQoe3Bvc2l0aW9uczoge3NpemU6IDIsIHVwZGF0ZX19KTtcbiAgdC5vayhhdHRyaWJ1dGVNYW5hZ2VyLmdldEF0dHJpYnV0ZXMoKVsncG9zaXRpb25zJ10sXG4gICAgJ0F0dHJpYnV0ZU1hbmFnZXIuYWRkIC0gYWRkIGF0dHJpYnV0ZSBzdWNjZXNzZnVsJyk7XG4gIHQuZW5kKCk7XG59KTtcblxudGVzdCgnQ29yZSNBdHRyaWJ1dGVNYW5hZ2VyLnVwZGF0ZScsIHQgPT4ge1xuICBjb25zdCBhdHRyaWJ1dGVNYW5hZ2VyID0gbmV3IEF0dHJpYnV0ZU1hbmFnZXIoKTtcbiAgYXR0cmlidXRlTWFuYWdlci5hZGQoe3Bvc2l0aW9uczoge3NpemU6IDIsIHVwZGF0ZX19KTtcblxuICBsZXQgYXR0cmlidXRlO1xuXG4gIC8vIEZpcnN0IHVwZGF0ZSwgc2hvdWxkIGF1dG9hbGxvYyBhbmQgdXBkYXRlIHRoZSB2YWx1ZSBhcnJheVxuICBhdHRyaWJ1dGVNYW5hZ2VyLnVwZGF0ZSh7XG4gICAgbnVtSW5zdGFuY2VzOiAxLFxuICAgIGRhdGE6IFt7fV1cbiAgfSk7XG5cbiAgYXR0cmlidXRlID0gYXR0cmlidXRlTWFuYWdlci5nZXRBdHRyaWJ1dGVzKClbJ3Bvc2l0aW9ucyddO1xuICB0Lm9rKEFycmF5QnVmZmVyLmlzVmlldyhhdHRyaWJ1dGUudmFsdWUpLCAnYXR0cmlidXRlIGhhcyB0eXBlZCBhcnJheScpO1xuICB0LmVxdWFscyhhdHRyaWJ1dGUudmFsdWVbMV0sIDEsICdhdHRyaWJ1dGUgdmFsdWUgaXMgY29ycmVjdCcpO1xuXG4gIC8vIFNlY29uZCB1cGRhdGUgd2l0aG91dCBpbnZhbGlkYXRpb24sIHNob3VsZCBub3QgdXBkYXRlXG4gIGF0dHJpYnV0ZS52YWx1ZVsxXSA9IDI7XG5cbiAgYXR0cmlidXRlTWFuYWdlci51cGRhdGUoe1xuICAgIG51bUluc3RhbmNlczogMSxcbiAgICBkYXRhOiBbe31dXG4gIH0pO1xuXG4gIGF0dHJpYnV0ZSA9IGF0dHJpYnV0ZU1hbmFnZXIuZ2V0QXR0cmlidXRlcygpWydwb3NpdGlvbnMnXTtcbiAgdC5vayhBcnJheUJ1ZmZlci5pc1ZpZXcoYXR0cmlidXRlLnZhbHVlKSwgJ2F0dHJpYnV0ZSBoYXMgdHlwZWQgYXJyYXknKTtcbiAgdC5lcXVhbHMoYXR0cmlidXRlLnZhbHVlWzFdLCAyLFxuICAgICdTZWNvbmQgdXBkYXRlLCBhdHRyaWJ1dGUgdmFsdWUgd2FzIG5vdCBjaGFuZ2VkJyk7XG5cbiAgLy8gVGhpcmQgdXBkYXRlLCB3aXRoIGludmFsaWRhdGlvbiwgc2hvdWxkIHVwZGF0ZVxuICBhdHRyaWJ1dGVNYW5hZ2VyLmludmFsaWRhdGVBbGwoKTtcbiAgYXR0cmlidXRlTWFuYWdlci51cGRhdGUoe1xuICAgIG51bUluc3RhbmNlczogMSxcbiAgICBkYXRhOiBbe31dXG4gIH0pO1xuXG4gIGF0dHJpYnV0ZSA9IGF0dHJpYnV0ZU1hbmFnZXIuZ2V0QXR0cmlidXRlcygpWydwb3NpdGlvbnMnXTtcbiAgdC5vayhBcnJheUJ1ZmZlci5pc1ZpZXcoYXR0cmlidXRlLnZhbHVlKSwgJ2F0dHJpYnV0ZSBoYXMgdHlwZWQgYXJyYXknKTtcbiAgdC5lcXVhbHMoYXR0cmlidXRlLnZhbHVlWzFdLCAxLFxuICAgICdUaGlyZCB1cGRhdGUsIGF0dHJpYnV0ZSB2YWx1ZSB3YXMgdXBkYXRlZCcpO1xuXG4gIHQuZW5kKCk7XG59KTtcblxudGVzdCgnQ29yZSNBdHRyaWJ1dGVNYW5hZ2VyLnVwZGF0ZSAtIDAgbnVtSW5zdGFuY2VzJywgdCA9PiB7XG4gIGNvbnN0IGF0dHJpYnV0ZU1hbmFnZXIgPSBuZXcgQXR0cmlidXRlTWFuYWdlcigpO1xuICBhdHRyaWJ1dGVNYW5hZ2VyLmFkZCh7cG9zaXRpb25zOiB7c2l6ZTogMiwgdXBkYXRlfX0pO1xuXG4gIC8vIEZpcnN0IHVwZGF0ZSwgc2hvdWxkIGF1dG9hbGxvYyBhbmQgdXBkYXRlIHRoZSB2YWx1ZSBhcnJheVxuICBhdHRyaWJ1dGVNYW5hZ2VyLnVwZGF0ZSh7XG4gICAgbnVtSW5zdGFuY2VzOiAwLFxuICAgIGRhdGE6IFtdXG4gIH0pO1xuXG4gIGNvbnN0IGF0dHJpYnV0ZSA9IGF0dHJpYnV0ZU1hbmFnZXIuZ2V0QXR0cmlidXRlcygpWydwb3NpdGlvbnMnXTtcbiAgdC5vayhBcnJheUJ1ZmZlci5pc1ZpZXcoYXR0cmlidXRlLnZhbHVlKSwgJ2F0dHJpYnV0ZSBoYXMgdHlwZWQgYXJyYXknKTtcblxuICB0LmVuZCgpO1xufSk7XG4iXX0=